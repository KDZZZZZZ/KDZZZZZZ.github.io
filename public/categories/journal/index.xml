<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Journal on Oops</title>
    <link>http://localhost:64303/categories/journal/</link>
    <description>Recent content in Journal on Oops</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 28 Jan 2025 00:00:00 +0800</lastBuildDate>
    <atom:link href="http://localhost:64303/categories/journal/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>TVM Function objects and registration implementation</title>
      <link>http://localhost:64303/posts/tvm%E4%BB%A3%E7%A0%81%E5%BA%93%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1%E5%8F%8A%E6%B3%A8%E5%86%8C%E5%AE%9E%E7%8E%B0/</link>
      <pubDate>Tue, 28 Jan 2025 00:00:00 +0800</pubDate>
      <guid>http://localhost:64303/posts/tvm%E4%BB%A3%E7%A0%81%E5%BA%93%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1%E5%8F%8A%E6%B3%A8%E5%86%8C%E5%AE%9E%E7%8E%B0/</guid>
      <description>&lt;p&gt;首先给出TVM中注册自定义函数和调用自定义函数的方法&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 注册函数&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;TVM_REGISTER_GLOBAL(&lt;span style=&#34;color:#4070a0&#34;&gt;&amp;#34;add&amp;#34;&lt;/span&gt;).set_body([](TVMArgs args, TVMRetValue&lt;span style=&#34;color:#666&#34;&gt;*&lt;/span&gt; ret) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#902000&#34;&gt;int&lt;/span&gt; a &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; args[&lt;span style=&#34;color:#40a070&#34;&gt;0&lt;/span&gt;];&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#902000&#34;&gt;int&lt;/span&gt; b &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; args[&lt;span style=&#34;color:#40a070&#34;&gt;1&lt;/span&gt;];&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#666&#34;&gt;*&lt;/span&gt;ret &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; a &lt;span style=&#34;color:#666&#34;&gt;+&lt;/span&gt; b;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;});&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 调用函数&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;PackedFunc add &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; runtime&lt;span style=&#34;color:#666&#34;&gt;::&lt;/span&gt;Registry&lt;span style=&#34;color:#666&#34;&gt;::&lt;/span&gt;Get(&lt;span style=&#34;color:#4070a0&#34;&gt;&amp;#34;add&amp;#34;&lt;/span&gt;);&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#902000&#34;&gt;int&lt;/span&gt; result &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; add(&lt;span style=&#34;color:#40a070&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#40a070&#34;&gt;5&lt;/span&gt;);  &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 返回 8&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;TVM实现注册Lambda函数的&lt;code&gt;set_body&lt;/code&gt;函数是一个指向&lt;code&gt;PackedFunc&lt;/code&gt;类型的指针.&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;TVM_REGISTER_GLOBAL&lt;/code&gt;的实现如下：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020&#34;&gt;#define REGISTER_GLOBAL(name, func) \&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020&#34;&gt;  tvm::runtime::FRegistry::Register(name, tvm::runtime::PackedFunc(func))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用全局哈希表&lt;code&gt;FRegistry&lt;/code&gt;注册函数。通过宏&lt;code&gt;REGISTER_GLOBAL(&amp;quot;func_name&amp;quot;, MyFunction)&lt;/code&gt;将函数与名称绑定，后续通过&lt;code&gt;GetPackedFunc(&amp;quot;func_name&amp;quot;)&lt;/code&gt;查找.&lt;/p&gt;&#xA;&lt;p&gt;使用&lt;code&gt;REGISTER_GLOBAL&lt;/code&gt;宏将函数与名称绑定。这个宏会调用&lt;code&gt;FRegistry::Register&lt;/code&gt;方法，将函数存储到全局哈希表中。&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;PackedFunc&lt;/code&gt;类型继承自&lt;code&gt;ObjectRef&lt;/code&gt;基类，实现了运算符重载，又用&lt;code&gt;make_object&lt;/code&gt;函数创建一个&lt;code&gt;PackedFuncSubObj&lt;/code&gt;类型对象，这个对象可以储存可调用对象.&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;PackedFuncSubObj&lt;/code&gt;继承自&lt;code&gt;PackedFuncObj&lt;/code&gt;, 这是&lt;code&gt;Object&lt;/code&gt;的子类，&lt;code&gt;Object&lt;/code&gt;实现了引用计数和类型检查，&lt;code&gt;PackedFunObj&lt;/code&gt;对函数指针、参数和返回值指针进行了打包。&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;PackedFuncSubObj&lt;/code&gt;类型用&lt;code&gt;std::remove_reference&lt;/code&gt;和&lt;code&gt;std::remove_cv&lt;/code&gt;进行了类型擦除，对&lt;code&gt;const&lt;/code&gt;、&lt;code&gt;volatile&lt;/code&gt;和引用进行去壳，移除我们不需要的特性.&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;PackedFuncSubObj&lt;/code&gt;中定义了&lt;code&gt;Extractor&lt;/code&gt;提取器结构，提取器内部的&lt;code&gt;Call&lt;/code&gt;函数是一个指针，用来调用可调用对象。&lt;/p&gt;&#xA;&lt;p&gt;接下来解释一下参数和返回值的数据结构。&lt;/p&gt;&#xA;&lt;p&gt;分别是&lt;code&gt;TVMArgs&lt;/code&gt;和&lt;code&gt;TVMRetValue&lt;/code&gt;,都使用了联合体&lt;code&gt;TVMValue&lt;/code&gt;对数据进行打包并进行了运算符重载和用于数据传递的基本方法。&lt;/p&gt;&#xA;&lt;p&gt;以上所有的实现基本都在&lt;code&gt;include/tvm/runtime/packed_func.h&lt;/code&gt;、&lt;code&gt;include/tvm/runtime/registry.h&lt;/code&gt;和&lt;code&gt;src/runtime/registry.cc&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;Python&lt;/code&gt;封装了&lt;code&gt;ctypes&lt;/code&gt;库，能够通过&lt;code&gt;name&lt;/code&gt;查找全局注册的C++函数并获得函数句柄，调用后得到传回的返回值。&#xA;其中对数据类型的包装也是TVM实现任意语言互相调用的关键.&lt;/p&gt;</description>
    </item>
    <item>
      <title>Hello World</title>
      <link>http://localhost:64303/posts/hello-world/</link>
      <pubDate>Sat, 28 Dec 2024 00:00:00 +0000</pubDate>
      <guid>http://localhost:64303/posts/hello-world/</guid>
      <description>&lt;h2 id=&#34;hello-world&#34;&gt;Hello, World!&lt;/h2&gt;&#xA;&lt;p&gt;This is my first blog post. Here, I&amp;rsquo;ll share some interesting tech insights and life experiences.&lt;/p&gt;&#xA;&lt;h3 id=&#34;why-start-a-blog&#34;&gt;Why Start a Blog?&lt;/h3&gt;&#xA;&lt;p&gt;Blogging helps me:&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;Document my learning journey&lt;/li&gt;&#xA;&lt;li&gt;Share technical insights&lt;/li&gt;&#xA;&lt;li&gt;Connect with like-minded people&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h3 id=&#34;future-plans&#34;&gt;Future Plans&lt;/h3&gt;&#xA;&lt;p&gt;I plan to write about:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Programming techniques&lt;/li&gt;&#xA;&lt;li&gt;Learning experiences&lt;/li&gt;&#xA;&lt;li&gt;Life reflections&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Stay tuned!&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
