<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Technical on Oops</title>
    <link>http://localhost:64303/categories/technical/</link>
    <description>Recent content in Technical on Oops</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 28 Jan 2025 00:00:00 +0800</lastBuildDate>
    <atom:link href="http://localhost:64303/categories/technical/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>TVM代码库解析：Relay层结构与优化Pass</title>
      <link>http://localhost:64303/posts/tvm%E4%BB%A3%E7%A0%81%E5%BA%93%E8%A7%A3%E6%9E%90relay%E5%B1%82%E7%BB%93%E6%9E%84%E4%B8%8E%E4%BC%98%E5%8C%96pass/</link>
      <pubDate>Tue, 28 Jan 2025 00:00:00 +0800</pubDate>
      <guid>http://localhost:64303/posts/tvm%E4%BB%A3%E7%A0%81%E5%BA%93%E8%A7%A3%E6%9E%90relay%E5%B1%82%E7%BB%93%E6%9E%84%E4%B8%8E%E4%BC%98%E5%8C%96pass/</guid>
      <description>&lt;p&gt;relay层主要由数据结构类(如Constant)和节点类(如ConstantNode)组成。&#xA;下面梳理一下他们的继承链。&lt;/p&gt;&#xA;&lt;p&gt;ObjectRef → BaseExpr → RelayExpr → Constant&lt;/p&gt;&#xA;&lt;p&gt;Object → BaseExprNode → RelayExprNode → ConstantNode&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;源代码库中使用了&lt;code&gt;using ExprNode = tvm::RelayExprNode;&lt;/code&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;这里先赘述一下上面每个类的的功能：&lt;/p&gt;&#xA;&lt;h4 id=&#34;1-object-includetvmruntimeobjecth&#34;&gt;&lt;strong&gt;(1) &lt;code&gt;Object&lt;/code&gt; (include/tvm/runtime/object.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;TVM &lt;strong&gt;所有对象的基类&lt;/strong&gt;，提供 &lt;strong&gt;引用计数&lt;/strong&gt; 和 &lt;strong&gt;类型系统&lt;/strong&gt; 支持&lt;/li&gt;&#xA;&lt;li&gt;实现 &lt;code&gt;RefCount&lt;/code&gt; 机制（通过 &lt;code&gt;use_count&lt;/code&gt; 成员）&lt;/li&gt;&#xA;&lt;li&gt;提供 &lt;code&gt;type_index&lt;/code&gt; 用于运行时类型识别（RTTI）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;关键方法&lt;/strong&gt;：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;virtual&lt;/span&gt; &lt;span style=&#34;color:#902000&#34;&gt;uint32_t&lt;/span&gt; &lt;span style=&#34;color:#06287e&#34;&gt;type_index&lt;/span&gt;() &lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;const&lt;/span&gt;; &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 类型标识&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#902000&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#06287e&#34;&gt;IncRef&lt;/span&gt;();  &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 增加引用计数&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#902000&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#06287e&#34;&gt;DecRef&lt;/span&gt;();  &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 减少引用计数&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;2-objectref-includetvmruntimeobjecth&#34;&gt;&lt;strong&gt;(2) &lt;code&gt;ObjectRef&lt;/code&gt; (include/tvm/runtime/object.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;所有 &lt;strong&gt;对象引用&lt;/strong&gt; 的基类模板（如 &lt;code&gt;Constant&lt;/code&gt; 本质是 &lt;code&gt;ObjectRef&amp;lt;ConstantNode&amp;gt;&lt;/code&gt;）&lt;/li&gt;&#xA;&lt;li&gt;通过智能指针 (&lt;code&gt;ObjectPtr&lt;/code&gt;) &lt;strong&gt;管理 Object 子类的生命周期&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;提供 &lt;strong&gt;类型安全转换接口&lt;/strong&gt;（如 &lt;code&gt;as&amp;lt;T&amp;gt;()&lt;/code&gt;）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;关键行为&lt;/strong&gt;：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;template&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;typename&lt;/span&gt; T&lt;span style=&#34;color:#666&#34;&gt;&amp;gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;const&lt;/span&gt; T&lt;span style=&#34;color:#666&#34;&gt;*&lt;/span&gt; as() &lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;const&lt;/span&gt;; &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 安全类型转换&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;operator&lt;/span&gt; &lt;span style=&#34;color:#06287e&#34;&gt;bool&lt;/span&gt;() &lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;const&lt;/span&gt;; &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 检查是否非空&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;3-baseexprnode-includetvmirexprh&#34;&gt;&lt;strong&gt;(3) &lt;code&gt;BaseExprNode&lt;/code&gt; (include/tvm/ir/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;Object&lt;/code&gt; → &lt;code&gt;BaseExprNode&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;所有 &lt;strong&gt;表达式节点&lt;/strong&gt; 的抽象基类&lt;/li&gt;&#xA;&lt;li&gt;定义表达式通用接口：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;数据类型 (&lt;code&gt;dtype&lt;/code&gt;)&lt;/li&gt;&#xA;&lt;li&gt;源码位置 (&lt;code&gt;span&lt;/code&gt;)&lt;/li&gt;&#xA;&lt;li&gt;虚函数 &lt;code&gt;SEqualReduce&lt;/code&gt;（用于结构相等性比较）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;关键成员&lt;/strong&gt;：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;runtime&lt;span style=&#34;color:#666&#34;&gt;::&lt;/span&gt;DataType dtype; &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 数据类型（如 float32）&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;Span span;               &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 源码位置信息（用于调试）&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;4-baseexpr-includetvmirexprh&#34;&gt;&lt;strong&gt;(4) &lt;code&gt;BaseExpr&lt;/code&gt; (include/tvm/ir/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;ObjectRef&lt;/code&gt; → &lt;code&gt;BaseExpr&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;所有 &lt;strong&gt;表达式引用&lt;/strong&gt; 的基类（如 &lt;code&gt;Constant&lt;/code&gt;、&lt;code&gt;Var&lt;/code&gt; 等）&lt;/li&gt;&#xA;&lt;li&gt;提供对 &lt;code&gt;BaseExprNode&lt;/code&gt; 的通用访问接口&lt;/li&gt;&#xA;&lt;li&gt;重载运算符（如 &lt;code&gt;operator==&lt;/code&gt;）实现表达式比较&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;5-relayexprnode-includetvmirexprh&#34;&gt;&lt;strong&gt;(5) &lt;code&gt;RelayExprNode&lt;/code&gt; (include/tvm/ir/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;BaseExprNode&lt;/code&gt; → &lt;code&gt;RelayExprNode&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;Relay 表达式体系的节点基类&lt;/strong&gt;，定义所有高层计算图节点的通用行为&lt;/li&gt;&#xA;&lt;li&gt;存储 Relay 特有的元数据：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;类型信息&lt;/strong&gt; (&lt;code&gt;checked_type_&lt;/code&gt;): 类型推断后的结果（如 &lt;code&gt;TensorType(shape=[1,3], dtype=float32)&lt;/code&gt;）&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;源码位置&lt;/strong&gt; (&lt;code&gt;span&lt;/code&gt;): 用于调试和错误定位&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;实现 &lt;strong&gt;结构等价性检查&lt;/strong&gt; (&lt;code&gt;SEqualReduce&lt;/code&gt;) 和 &lt;strong&gt;哈希生成&lt;/strong&gt; (&lt;code&gt;SHashReduce&lt;/code&gt;) 的虚函数&lt;/li&gt;&#xA;&lt;li&gt;支持 &lt;strong&gt;递归遍历子节点&lt;/strong&gt; 的接口（用于优化 Pass 或分析）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;关键成员&lt;/strong&gt;：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#007020;font-weight:bold&#34;&gt;mutable&lt;/span&gt; Type checked_type_;  &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 类型推断结果（可缓存）&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;Span span;                   &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 源码位置信息&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;典型子类&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;ConstantNode&lt;/code&gt;（常量）&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;VarNode&lt;/code&gt;（变量）&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;CallNode&lt;/code&gt;（函数调用）&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;FunctionNode&lt;/code&gt;（函数定义）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;6-relayexpr-includetvmirexprh&#34;&gt;&lt;strong&gt;(6) &lt;code&gt;RelayExpr&lt;/code&gt; (include/tvm/ir/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;BaseExpr&lt;/code&gt; → &lt;code&gt;RelayExpr&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;通过&lt;code&gt;TVM_DEFINE_OBJECT_REF_METHODS&lt;/code&gt;宏定义了对象引用管理、类型转换和节点访问的功能&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;7-constantnode-includetvmrelayexprh&#34;&gt;&lt;strong&gt;(7) &lt;code&gt;ConstantNode&lt;/code&gt; (include/tvm/relay/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;RelayExprNode&lt;/code&gt; → &lt;code&gt;ConstantNode&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;存储常量数据的节点&lt;/strong&gt;（具体实现）&lt;/li&gt;&#xA;&lt;li&gt;持有 &lt;code&gt;runtime::NDArray&lt;/code&gt; 表示常量值&lt;/li&gt;&#xA;&lt;li&gt;实现 &lt;code&gt;SEqualReduce&lt;/code&gt; 比较常量值是否相等&lt;/li&gt;&#xA;&lt;li&gt;实现 &lt;code&gt;SHashReduce&lt;/code&gt; 生成哈希值&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;关键成员&lt;/strong&gt;：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;runtime&lt;span style=&#34;color:#666&#34;&gt;::&lt;/span&gt;NDArray data; &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 常量数据（可以是标量或张量）&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;8-constant-includetvmrelayexprh&#34;&gt;&lt;strong&gt;(8) &lt;code&gt;Constant&lt;/code&gt; (include/tvm/relay/expr.h)&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;继承关系&lt;/strong&gt;：&lt;code&gt;RelayExpr&lt;/code&gt; → &lt;code&gt;Constant&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;功能&lt;/strong&gt;：&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;用户直接使用的常量包装类&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;构造函数封装 &lt;code&gt;ConstantNode&lt;/code&gt; 的创建&lt;/li&gt;&#xA;&lt;li&gt;提供对 &lt;code&gt;data&lt;/code&gt; 的安全访问方法&lt;/li&gt;&#xA;&lt;li&gt;示例用法：&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;NDArray arr &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; ...;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Constant c &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; Constant(arr);  &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 创建常量&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;&lt;/span&gt;Expr expr &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; c;               &lt;span style=&#34;color:#60a0b0;font-style:italic&#34;&gt;// 可隐式转换为基类&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;有了对基类的功能认识，我们只需要继续了解类似&lt;code&gt;Constant&lt;/code&gt;和&lt;code&gt;ConstantNode&lt;/code&gt;类的其他主要类实现。&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
